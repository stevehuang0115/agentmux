<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentMux Factory</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      overflow: hidden;
      background: #111721;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    canvas {
      display: block;
    }
    /* Icon styles */
    .icon {
      width: 16px;
      height: 16px;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px;
    }
    .icon svg {
      width: 100%;
      height: 100%;
      fill: currentColor;
    }
    #info {
      position: absolute;
      top: 15px;
      left: 15px;
      color: #f6f7f8;
      font-size: 14px;
      background: rgba(26, 34, 44, 0.9);
      padding: 15px 20px;
      border-radius: 8px;
      border: 1px solid #313a48;
      backdrop-filter: blur(10px);
      min-width: 250px;
    }
    #info strong {
      font-size: 16px;
      display: block;
      margin-bottom: 8px;
      color: #2a73ea;
      font-weight: 600;
    }
    #lighting-toggle {
      position: absolute;
      top: 15px;
      left: 280px;
      display: flex;
      gap: 8px;
    }
    #lighting-toggle .lighting-btn {
      background: rgba(26, 34, 44, 0.9);
      color: #9ab0d9;
      border: 1px solid #313a48;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #lighting-toggle .lighting-btn:hover {
      background: rgba(42, 115, 234, 0.2);
      border-color: rgba(42, 115, 234, 0.5);
      color: #f6f7f8;
    }
    #lighting-toggle .lighting-btn.active {
      background: rgba(42, 115, 234, 0.3);
      border-color: #2a73ea;
      color: #f6f7f8;
    }
    #legend {
      position: absolute;
      bottom: 15px;
      left: 15px;
      color: #f6f7f8;
      font-size: 12px;
      background: rgba(26, 34, 44, 0.9);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #313a48;
    }
    #legend h4 {
      margin-bottom: 8px;
      color: #9ab0d9;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #legend .item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 4px 0;
    }
    #legend .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    #legend .dot.active { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
    #legend .dot.idle { background: #eab308; box-shadow: 0 0 6px #eab308; }
    #legend .dot.dormant { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
    #controls {
      position: absolute;
      top: 15px;
      right: 15px;
      color: #f6f7f8;
      font-size: 12px;
      background: rgba(26, 34, 44, 0.9);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #313a48;
    }
    #controls h4 {
      margin-bottom: 8px;
      color: #9ab0d9;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #controls code {
      background: rgba(255,255,255,0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }
    #project-focus {
      position: absolute;
      top: 170px;
      right: 15px;
      color: #f6f7f8;
      font-size: 12px;
      background: rgba(26, 34, 44, 0.9);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #313a48;
      min-width: 180px;
    }
    #project-focus h4 {
      margin-bottom: 8px;
      color: #9ab0d9;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #project-buttons {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #project-buttons button {
      background: rgba(42, 115, 234, 0.15);
      color: #2a73ea;
      border: 1px solid rgba(42, 115, 234, 0.3);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
      text-align: left;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #project-buttons button:hover {
      background: rgba(42, 115, 234, 0.25);
      border-color: #2a73ea;
    }
    #project-buttons button.active {
      background: rgba(42, 115, 234, 0.35);
      border-color: #2a73ea;
    }
    #project-buttons button svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    #usage {
      position: absolute;
      bottom: 15px;
      right: 240px;
      color: #f6f7f8;
      font-size: 12px;
      background: rgba(26, 34, 44, 0.9);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #313a48;
      min-width: 180px;
    }
    #usage h4 {
      margin-bottom: 8px;
      color: #9ab0d9;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #usage .stat {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    #usage .stat-label {
      color: #9ab0d9;
    }
    #usage .stat-value {
      color: #2a73ea;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
    #usage .stat-value.tokens {
      color: #a855f7;
    }
    #usage .mini-chart {
      margin-top: 10px;
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 30px;
    }
    #usage .mini-chart .bar {
      flex: 1;
      background: linear-gradient(to top, #2a73ea, #a855f7);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
    }

    #token-dist {
      position: absolute;
      bottom: 15px;
      right: 15px;
      color: #f6f7f8;
      font-size: 12px;
      background: rgba(26, 34, 44, 0.9);
      padding: 12px 15px;
      border-radius: 8px;
      border: 1px solid #313a48;
      min-width: 210px;
    }
    #token-dist h4 {
      margin-bottom: 8px;
      color: #9ab0d9;
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    #token-dist .dist-bar-container {
      display: flex;
      height: 16px;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(255,255,255,0.1);
      margin-bottom: 10px;
    }
    #token-dist .dist-bar-segment {
      height: 100%;
      transition: width 0.5s ease;
    }
    #token-dist .dist-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #token-dist .dist-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    #token-dist .dist-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
    #token-dist .dist-name {
      flex: 1;
      color: #9ab0d9;
    }
    #token-dist .dist-percent {
      color: #2a73ea;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Desktop panel collapse/expand functionality */
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .panel-header h4 {
      margin-bottom: 0 !important;
    }
    .panel-toggle-btn {
      background: none;
      border: none;
      color: #9ab0d9;
      cursor: pointer;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border-radius: 4px;
    }
    .panel-toggle-btn:hover {
      color: #2a73ea;
      background: rgba(42, 115, 234, 0.15);
    }
    .panel-toggle-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.2s;
    }
    .panel-collapsed .panel-toggle-btn svg {
      transform: rotate(180deg);
    }
    .panel-content {
      transition: all 0.2s ease;
      overflow: hidden;
    }
    .panel-collapsed .panel-content {
      display: none;
    }
    .panel-collapsed {
      padding: 10px 15px !important;
    }
    .panel-collapsed .panel-header {
      margin-bottom: 0;
    }

    /* Mobile lighting controls - hidden on desktop */
    #mobile-lighting {
      display: none;
    }
    .mobile-lighting-buttons {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .mobile-light-btn {
      flex: 1;
      background: rgba(42, 115, 234, 0.1);
      color: #9ab0d9;
      border: 1px solid #313a48;
      padding: 8px 6px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      font-family: inherit;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }
    .mobile-light-btn:hover {
      background: rgba(42, 115, 234, 0.2);
      border-color: rgba(42, 115, 234, 0.5);
      color: #f6f7f8;
    }
    .mobile-light-btn.active {
      background: rgba(42, 115, 234, 0.3);
      border-color: #2a73ea;
      color: #f6f7f8;
    }

    /* Mobile toggle buttons for collapsible panels */
    .panel-toggle {
      display: none;
      position: absolute;
      width: 44px;
      height: 44px;
      background: rgba(26, 34, 44, 0.95);
      border: 2px solid #2a73ea;
      border-radius: 12px;
      color: #2a73ea;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .panel-toggle:hover {
      background: rgba(42, 115, 234, 0.3);
      border-color: #2a73ea;
      color: #f6f7f8;
    }
    .panel-toggle.active {
      background: rgba(42, 115, 234, 0.4);
      border-color: #5a9eff;
      color: #f6f7f8;
    }
    .panel-toggle svg {
      width: 22px;
      height: 22px;
    }

    /* Mobile-specific toggles positioning */
    #toggle-info { top: 10px; left: 10px; }
    #toggle-projects { top: 10px; right: 10px; }
    #toggle-stats { bottom: 10px; left: 10px; }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      /* Show toggle buttons on mobile */
      .panel-toggle {
        display: flex;
        z-index: 200;
      }

      /* Hide keyboard controls completely on mobile */
      #controls {
        display: none !important;
      }

      /* Hide lighting toggle on mobile (less important) */
      #lighting-toggle {
        display: none !important;
      }

      /* All panels hidden by default on mobile */
      #info,
      #legend,
      #project-focus,
      #usage,
      #token-dist {
        display: none;
        max-width: calc(100vw - 30px);
        z-index: 150;
      }

      /* Show panels when expanded */
      #info.expanded,
      #legend.expanded,
      #project-focus.expanded,
      #usage.expanded,
      #token-dist.expanded {
        display: block;
      }

      /* Adjust info panel positioning */
      #info {
        top: 60px;
        left: 10px;
        right: auto;
        min-width: auto;
        max-width: 200px;
        font-size: 12px;
        padding: 10px 12px;
      }
      #info strong {
        font-size: 14px;
        margin-bottom: 6px;
      }

      /* Legend positioning - part of info toggle */
      #legend {
        top: auto;
        bottom: 60px;
        left: 10px;
        font-size: 11px;
        padding: 10px 12px;
      }

      /* Show mobile lighting controls on mobile */
      #mobile-lighting {
        display: block;
        border-top: 1px solid #313a48;
        padding-top: 8px;
        margin-top: 8px;
      }

      /* Project focus positioning */
      #project-focus {
        top: 60px;
        right: 10px;
        left: auto;
        min-width: 160px;
        max-width: 200px;
        font-size: 11px;
        padding: 10px 12px;
        max-height: calc(100vh - 150px);
        overflow-y: auto;
      }
      #project-buttons button {
        padding: 8px 10px;
        font-size: 12px;
      }

      /* Stats panels - positioned on left side */
      #usage {
        top: auto;
        bottom: 60px;
        right: auto;
        left: 10px;
        min-width: auto;
        max-width: 200px;
        font-size: 11px;
        padding: 10px 12px;
      }

      #token-dist {
        top: auto;
        bottom: 180px;
        right: auto;
        left: 10px;
        min-width: auto;
        max-width: 220px;
        font-size: 11px;
        padding: 10px 12px;
      }
    }

    /* Very small screens */
    @media (max-width: 400px) {
      #info, #project-focus, #usage, #token-dist {
        max-width: calc(100vw - 20px);
        left: 10px;
        right: 10px;
      }

      #project-focus {
        left: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile toggle buttons -->
  <button id="toggle-info" class="panel-toggle" onclick="togglePanel('info')" title="Status & Info">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="16" x2="12" y2="12"/>
      <line x1="12" y1="8" x2="12.01" y2="8"/>
    </svg>
  </button>
  <button id="toggle-projects" class="panel-toggle" onclick="togglePanel('projects')" title="Camera Views">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
      <circle cx="12" cy="13" r="4"/>
    </svg>
  </button>
  <button id="toggle-stats" class="panel-toggle" onclick="togglePanel('stats')" title="Statistics">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="18" y1="20" x2="18" y2="10"/>
      <line x1="12" y1="20" x2="12" y2="4"/>
      <line x1="6" y1="20" x2="6" y2="14"/>
    </svg>
  </button>

  <div id="info">
    <strong>AgentMux Factory</strong>
    Loading...
  </div>

  <div id="lighting-toggle">
    <button class="lighting-btn active" data-mode="auto" onclick="window.setLightingMode('auto')">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        <polyline points="17 8 21 12 17 16"/>
      </svg>
      Auto
    </button>
    <button class="lighting-btn" data-mode="day" onclick="window.setLightingMode('day')">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      Day
    </button>
    <button class="lighting-btn" data-mode="night" onclick="window.setLightingMode('night')">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
      Night
    </button>
  </div>

  <div id="legend">
    <div class="panel-header" onclick="toggleDesktopPanel('legend')">
      <h4>Status</h4>
      <button class="panel-toggle-btn" title="Toggle panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div style="margin-top: 8px;">
        <div class="item"><span class="dot active"></span> Active (typing, screen on)</div>
        <div class="item"><span class="dot idle"></span> Idle (sleepy, coffee break)</div>
        <div class="item"><span class="dot dormant"></span> Dormant (gone home)</div>
      </div>

      <!-- Mobile lighting controls -->
      <div id="mobile-lighting">
        <h4 style="margin-top: 12px;">Lighting</h4>
        <div class="mobile-lighting-buttons">
          <button class="mobile-light-btn active" data-mode="auto" onclick="window.setLightingMode('auto')">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
              <polyline points="17 8 21 12 17 16"/>
            </svg>
            Auto
          </button>
          <button class="mobile-light-btn" data-mode="day" onclick="window.setLightingMode('day')">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
            </svg>
            Day
          </button>
          <button class="mobile-light-btn" data-mode="night" onclick="window.setLightingMode('night')">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            Night
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="controls">
    <div class="panel-header" onclick="toggleDesktopPanel('controls')">
      <h4>Controls</h4>
      <button class="panel-toggle-btn" title="Toggle panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div style="margin-top: 8px;"><b>Drag</b> = Rotate view</div>
      <div><b>Scroll</b> = Zoom in/out</div>
      <div style="margin-top: 6px; border-top: 1px solid #313a48; padding-top: 6px;">
        <code>W/Up</code> Forward &nbsp; <code>S/Down</code> Back
      </div>
      <div>
        <code>A/Left</code> Right &nbsp; <code>D/Right</code> Left
      </div>
      <div>
        <code>Q/Space</code> Up &nbsp; <code>E/Shift</code> Down
      </div>
    </div>
  </div>

  <div id="project-focus">
    <div class="panel-header" onclick="toggleDesktopPanel('project-focus')">
      <h4>Camera Views</h4>
      <button class="panel-toggle-btn" title="Toggle panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div id="project-buttons" style="margin-top: 8px;">
        <!-- Buttons populated by JavaScript -->
      </div>
    </div>
  </div>

  <div id="usage">
    <div class="panel-header" onclick="toggleDesktopPanel('usage')">
      <h4>Token Usage</h4>
      <button class="panel-toggle-btn" title="Toggle panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div id="usage-content" style="margin-top: 8px;">Loading...</div>
    </div>
  </div>

  <div id="token-dist">
    <div class="panel-header" onclick="toggleDesktopPanel('token-dist')">
      <h4>Workload Distribution</h4>
      <button class="panel-toggle-btn" title="Toggle panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="18 15 12 9 6 15"/>
        </svg>
      </button>
    </div>
    <div class="panel-content">
      <div id="token-dist-content" style="margin-top: 8px;">Loading...</div>
    </div>
  </div>

  <!-- Panel toggle scripts -->
  <script>
    // Desktop panel collapse toggle
    function toggleDesktopPanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('panel-collapsed');
      }
    }
    window.toggleDesktopPanel = toggleDesktopPanel;

    // Mobile panel toggle state
    const panelState = {
      info: false,
      projects: false,
      stats: false
    };

    // Toggle panel visibility
    function togglePanel(panelName) {
      // Close all panels first
      Object.keys(panelState).forEach(key => {
        if (key !== panelName) {
          panelState[key] = false;
          updatePanelVisibility(key);
        }
      });

      // Toggle the selected panel
      panelState[panelName] = !panelState[panelName];
      updatePanelVisibility(panelName);
    }

    function updatePanelVisibility(panelName) {
      const toggleBtn = document.getElementById('toggle-' + panelName);

      if (panelName === 'info') {
        const infoPanel = document.getElementById('info');
        const legendPanel = document.getElementById('legend');
        if (panelState.info) {
          infoPanel.classList.add('expanded');
          legendPanel.classList.add('expanded');
          toggleBtn.classList.add('active');
        } else {
          infoPanel.classList.remove('expanded');
          legendPanel.classList.remove('expanded');
          toggleBtn.classList.remove('active');
        }
      } else if (panelName === 'projects') {
        const projectPanel = document.getElementById('project-focus');
        if (panelState.projects) {
          projectPanel.classList.add('expanded');
          toggleBtn.classList.add('active');
        } else {
          projectPanel.classList.remove('expanded');
          toggleBtn.classList.remove('active');
        }
      } else if (panelName === 'stats') {
        const usagePanel = document.getElementById('usage');
        const tokenDistPanel = document.getElementById('token-dist');
        if (panelState.stats) {
          usagePanel.classList.add('expanded');
          tokenDistPanel.classList.add('expanded');
          toggleBtn.classList.add('active');
        } else {
          usagePanel.classList.remove('expanded');
          tokenDistPanel.classList.remove('expanded');
          toggleBtn.classList.remove('active');
        }
      }
    }

    // Close panels when tapping on the 3D view (canvas)
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for canvas to be created by Three.js
      setTimeout(() => {
        const canvas = document.querySelector('canvas');
        if (canvas) {
          canvas.addEventListener('touchstart', (e) => {
            // Only close if a panel is open and tap is not on a panel
            const anyOpen = Object.values(panelState).some(v => v);
            if (anyOpen) {
              Object.keys(panelState).forEach(key => {
                panelState[key] = false;
                updatePanelVisibility(key);
              });
            }
          }, { passive: true });
        }
      }, 1000);
    });

    // Make togglePanel available globally
    window.togglePanel = togglePanel;
  </script>

  <script type="module" src="./src/main.js"></script>
</body>
</html>
